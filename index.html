
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Soroban</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100dvh;
      background: white;
      display: flex;
      justify-content: center;
      align-items: center;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
    }

    #container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .soroban {
      display: flex;
      justify-content: center;
      align-items: center;
      background: #8B4513;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .rod {
      position: relative;
      width: 60px;
      height: 250px;
      background: #D2B48C;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
    }

    .rod-line {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 4px;
      background: black;
      z-index: 0;
    }

    .heaven {
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      height: 12%;
      gap: 5px;
      z-index: 1;
    }

    .gap-space {
      height: 8%;
      z-index: 1;
    }

    .earth {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      height: 52%;
      margin-top: 5px;
      z-index: 1;
    }

    .bar {
      position: absolute;
      top: 30%;
      width: 100%;
      height: 8px;
      background: black;
      z-index: 2;
    }

    .bead {
      will-change: transform;
      width: 50px;
      height: 30px;
      background: radial-gradient(circle at 30% 30%, #444, #111);
      border-radius: 50% / 40%;
      box-shadow: inset -2px -2px 5px rgba(255, 255, 255, 0.2),
                  inset 2px 2px 5px rgba(0, 0, 0, 0.4);
      transition: transform .15s ease, background-color .15s ease;
      z-index: 3;
      touch-action: none;
    } 

     /* bead is under the finger → plain white */
    .bead.dragging {
      transition: none;                                /* no easing while moving */
      background: radial-gradient(circle at 30% 30%, #fff, #dcdcdc);
      box-shadow: inset -2px -2px 5px rgba(0,0,0,.05),
              inset  2px  2px 5px rgba(0,0,0,.25);
    }

    /* bead counted (snapped “on”) → yellow */
    .bead.active {
      background: radial-gradient(circle at 30% 30%, #ffd700, #ffbf00);
      box-shadow: inset -2px -2px 5px rgba(255,255,255,.4),
              inset  2px  2px 5px rgba(0,0,0,.3);
    }      


    .bead.active {
      background: radial-gradient(circle at 30% 30%, #FFD700, #FFA500);
      box-shadow: inset -2px -2px 5px rgba(255, 255, 255, 0.4),
                  inset 2px 2px 5px rgba(0, 0, 0, 0.3);
    }

    .bead.heaven.active {
      transform: translateY(150%);
    }

    .bead.earth.active {
      transform: translateY(-150%);
    }

    @media (max-width: 768px) {
      .soroban {
        flex-wrap: wrap;
        gap: 5px;
      }

      .rod {
        width: 60px;
        height: 220px;
      }

      .bead {
        width: 40px;
        height: 25px;
      }
    }

    @media (max-width: 480px) {
      .soroban {
        gap: 3px;
      }

      .rod {
        width: 50px;
        height: 200px;
      }

      .bead {
        width: 35px;
        height: 22px;
      }
    }

    @media screen and (orientation: portrait) {
      body::before {
        content: "Please rotate your device";
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: black;
        color: white;
        font-size: 2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        text-align: center;
        padding: 1em;
      }
      #container {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="container">
    <div class="soroban">
      <!-- 7 rods -->
      <div class="rod">
      <div class="rod-line">
   </div>
      <div class="heaven">
      <div class="bead heaven">
   </div>
   </div>
      <div class="gap-space">
   </div>
      <div class="earth">
      <div class="bead earth">
   </div>
      <div class="bead earth">
   </div>
      <div class="bead earth">
   </div>
      <div class="bead earth">
   </div>
   </div>
      <div class="bar">
   </div>
   </div>

      <div class="rod"><div class="rod-line"></div><div class="heaven"><div class="bead heaven"></div></div><div class="gap-space"></div><div class="earth"><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div></div><div class="bar"></div></div>

      <div class="rod"><div class="rod-line"></div><div class="heaven"><div class="bead heaven"></div></div><div class="gap-space"></div><div class="earth"><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div></div><div class="bar"></div></div>

      <div class="rod"><div class="rod-line"></div><div class="heaven"><div class="bead heaven"></div></div><div class="gap-space"></div><div class="earth"><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div></div><div class="bar"></div></div>

      <div class="rod"><div class="rod-line"></div><div class="heaven"><div class="bead heaven"></div></div><div class="gap-space"></div><div class="earth"><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div></div><div class="bar"></div></div>

      <div class="rod"><div class="rod-line"></div><div class="heaven"><div class="bead heaven"></div></div><div class="gap-space"></div><div class="earth"><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div></div><div class="bar"></div></div>

      <div class="rod"><div class="rod-line"></div><div class="heaven"><div class="bead heaven"></div></div><div class="gap-space"></div><div class="earth"><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div><div class="bead earth"></div></div><div class="bar"></div></div>
    </div>
  </div>
<script>
/* =====================================================================
   Soroban – free-drag beads + snap-to-nearest + side-sweep + shake
   ===================================================================== */
(() => {
  const SHAKE_G   = 16;          // m/s² needed to reset
  const HAPTIC_MS = 12;          // vibration per snap (0 = mute)

  /* ───── shorthands ──── */
  const $  = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  /* ───── per-pointer store ──── */
  const fingers = new Map();   // id → state object

  /* ───── attach listeners ──── */
  $('.soroban').style.touchAction = 'none';   // kill scroll / zoom

  $$('.bead').forEach(bead => {
    bead.addEventListener('pointerdown',  down);
    bead.addEventListener('pointermove',  move);
    bead.addEventListener('pointerup',    up);
    bead.addEventListener('pointercancel',up);
  });

  /* ───── pointerdown ──── */
  function down (e) {
    const bead      = e.currentTarget;
    const rod       = bead.closest('.rod');
    const rodRect   = rod.getBoundingClientRect();
    const barRect   = rod.querySelector('.bar').getBoundingClientRect();
    const beadRect  = bead.getBoundingClientRect();
    const heaven    = bead.classList.contains('heaven');
    const bounds    = heaven
                      ? { top: rodRect.top,       bot: barRect.top - beadRect.height }
                      : { top: barRect.bottom,    bot: rodRect.bottom - beadRect.height };

    bead.setPointerCapture(e.pointerId);
    bead.classList.add('dragging');

    fingers.set(e.pointerId, {
      bead, heaven, bounds,
      startTop : beadRect.top,
      offsetY  : e.clientY - beadRect.top,
      lastRod  : rod
    });
  }

  /* ───── pointermove ──── */
  function move (e) {
    const f = fingers.get(e.pointerId);
    if (!f) return;

    /* follow finger */
    let newTop = e.clientY - f.offsetY;
    newTop = Math.max(f.bounds.top, Math.min(newTop, f.bounds.bot));
    f.bead.style.transform = translateY(${newTop - f.startTop}px);

    /* side-sweep: if we entered a new rod, copy visual drag there */
    const hit  = document.elementFromPoint(e.clientX, e.clientY);
    const rod  = hit?.closest?.('.rod');
    if (rod && rod !== f.lastRod) {
      const target = f.heaven
                   ? rod.querySelector('.bead.heaven')
                   : [...rod.querySelectorAll('.bead.earth')].pop();
      if (target && !target.classList.contains('dragging')) {
        target.style.transform = f.bead.style.transform;
      }
      f.lastRod = rod;
    }
  }

  /* ───── pointerup / cancel ──── */
  function up (e) {
    const f = fingers.get(e.pointerId);
    if (!f) return;

    const beadRect = f.bead.getBoundingClientRect();
    const rod      = f.bead.closest('.rod');
    const barRect  = rod.querySelector('.bar').getBoundingClientRect();
    const center   = beadRect.top + beadRect.height / 2;
    const barMid   = barRect.top + barRect.height / 2;

    /* decide active vs inactive by proximity */
    const makeActive = f.heaven ? center > barMid : center < barMid;

    snapBead(f.bead, makeActive);
    f.bead.classList.remove('dragging');
    f.bead.style.transform = '';           // let CSS place it
    f.bead.releasePointerCapture(e.pointerId);
    fingers.delete(e.pointerId);
  }

  /* ───── snap logic + colour + chain for earth beads ──── */
  function snapBead (bead, makeActive) {
    const heaven = bead.classList.contains('heaven');

    if (heaven) {
      bead.classList.toggle('active', makeActive);
    } else {
      const earths = [...bead.parentElement.children];
      const idx    = earths.indexOf(bead);
      if (makeActive) {
        for (let i = idx; i >= 0; i--) earths[i].classList.add('active');
      } else {
        for (let i = idx; i < earths.length; i++) earths[i].classList.remove('active');
      }
    }

    if (HAPTIC_MS) navigator.vibrate(HAPTIC_MS);
  }

  /* ───── shake-to-reset ──── */
  if (window.DeviceMotionEvent) {
    let last = 0;
    window.addEventListener('devicemotion', ev => {
      const { x, y, z } = ev.accelerationIncludingGravity;
      if (Math.hypot(x, y, z) > SHAKE_G && performance.now() - last > 750) {
        $$('.bead.active').forEach(b => b.classList.remove('active'));
        if (HAPTIC_MS) navigator.vibrate([0,40,40,40]);
        last = performance.now();
      }
    });
  }
})();
</script>
</body>
</html>
 
